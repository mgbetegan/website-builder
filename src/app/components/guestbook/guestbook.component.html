<div class="guestbook-container">
  <div class="guestbook-header">
    <h2>üìñ Livres d'Or</h2>
    <button class="btn-primary" (click)="showCreateForm = !showCreateForm">
      + Nouveau
    </button>
  </div>

  @if (showCreateForm) {
    <div class="create-form">
      <h3>Cr√©er un livre d'or</h3>
      <input type="text"
             [(ngModel)]="newGuestBookName"
             placeholder="Nom du livre d'or"
             class="input-field">
      <div class="form-actions">
        <button class="btn-success" (click)="createGuestBook()">Cr√©er</button>
        <button class="btn-cancel" (click)="showCreateForm = false">Annuler</button>
      </div>
    </div>
  }

  <div class="guestbook-content">
    <!-- List of guest books -->
    <div class="guestbook-list">
      <h3>Mes livres d'or</h3>
      @if (guestBooks.length === 0) {
        <p class="empty-message">Aucun livre d'or. Cr√©ez-en un !</p>
      }
      @for (gb of guestBooks; track gb.id) {
        <div class="guestbook-item"
             [class.selected]="selectedGuestBook?.id === gb.id"
             (click)="selectGuestBook(gb)">
          <div class="gb-info">
            <strong>{{ gb.name }}</strong>
            <small>{{ gb.entries.length }} entr√©es</small>
            @if (gb.templateOriginalName) {
              <small class="template-name">üìÑ {{ gb.templateOriginalName }}</small>
            }
          </div>
          <button class="btn-delete" (click)="deleteGuestBook(gb); $event.stopPropagation()">
            üóëÔ∏è
          </button>
        </div>
      }
    </div>

    <!-- Details panel -->
    @if (selectedGuestBook) {
      <div class="guestbook-details">
        <h3>{{ selectedGuestBook.name }}</h3>

        <!-- Template upload section -->
        <div class="section">
          <h4>1. Template DOCX</h4>
          @if (selectedGuestBook.templateOriginalName) {
            <p class="success-message">‚úì Template: {{ selectedGuestBook.templateOriginalName }}</p>
            @if (selectedGuestBook.fields && selectedGuestBook.fields.length > 0) {
              <p class="info-message">
                Champs d√©tect√©s: {{ selectedGuestBook.fields.join(', ') }}
              </p>
            }
          } @else {
            <p class="warning-message">‚ö†Ô∏è Aucun template upload√©</p>
          }

          <div class="upload-section">
            <input type="file"
                   accept=".docx"
                   (change)="onFileSelected($event)"
                   id="template-upload"
                   style="display: none;">
            <label for="template-upload" class="btn-secondary">
              Choisir un fichier .docx
            </label>
            @if (selectedFile) {
              <span class="file-name">{{ selectedFile.name }}</span>
              <button class="btn-primary" (click)="uploadTemplate()">
                Uploader
              </button>
            }
          </div>

          <a href="backend/GUESTBOOK_TEMPLATE_GUIDE.md" target="_blank" class="help-link">
            üìö Guide de cr√©ation de templates
          </a>
        </div>

        <!-- Entries section -->
        <div class="section">
          <h4>2. Entr√©es ({{ selectedGuestBook.entries.length }})</h4>

          @if (selectedGuestBook.templatePath) {
            <button class="btn-primary" (click)="showEntryForm = !showEntryForm">
              + Ajouter une entr√©e
            </button>

            @if (showEntryForm && selectedGuestBook.fields.length > 0) {
              <div class="entry-form">
                <h5>Nouvelle entr√©e</h5>
                @for (field of selectedGuestBook.fields; track field) {
                  @if (!field.startsWith('guestbook_') && !field.startsWith('total_') && !field.startsWith('date') && field !== 'entries') {
                    <div class="form-group">
                      <label>{{ getFieldLabel(field) }}</label>
                      <input type="text"
                             [(ngModel)]="entryData[field]"
                             class="input-field"
                             placeholder="Entrez {{ getFieldLabel(field).toLowerCase() }}">
                    </div>
                  }
                }
                <div class="form-actions">
                  <button class="btn-success" (click)="addEntry()">Ajouter</button>
                  <button class="btn-cancel" (click)="showEntryForm = false">Annuler</button>
                </div>
              </div>
            }

            @if (selectedGuestBook.entries.length > 0) {
              <div class="entries-list">
                @for (entry of selectedGuestBook.entries; track entry.id) {
                  <div class="entry-item">
                    @for (key of Object.keys(entry.data); track key) {
                      <div class="entry-field">
                        <strong>{{ getFieldLabel(key) }}:</strong> {{ entry.data[key] }}
                      </div>
                    }
                    <small class="entry-date">{{ entry.createdAt | date:'short' }}</small>
                  </div>
                }
              </div>
            }
          } @else {
            <p class="info-message">Uploadez d'abord un template pour ajouter des entr√©es</p>
          }
        </div>

        <!-- Generate section -->
        <div class="section">
          <h4>3. G√©n√©rer le document</h4>
          <button class="btn-generate"
                  [disabled]="!selectedGuestBook.templatePath || selectedGuestBook.entries.length === 0"
                  (click)="generateDocument()">
            üì• T√©l√©charger le livre d'or (DOCX)
          </button>
        </div>
      </div>
    } @else {
      <div class="no-selection">
        <p>S√©lectionnez un livre d'or pour voir les d√©tails</p>
      </div>
    }
  </div>
</div>
